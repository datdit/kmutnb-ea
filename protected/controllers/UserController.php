<?php// ob_start();// session_start();class UserController extends Controller {    public function actionUserListAll() {        Yii::app()->theme = "admin";        $model = new User("search");        $model->unsetAttributes();        if (isset($_GET ['User'])) {            $model->attributes = $_GET ['User'];        }        $this->render("/User/UserList", array("users" => $model));    }    public function actionUserForm($id = NULL) {        Yii::app()->theme = "admin";        $msg_text = "";        // print_r($_POST['User']);        // print_r($_POST['savetype']);        if (!empty($_POST ["User"])) {            $savetype = $_POST ['savetype']; // check return when saved            // ใช้ในกรณีแก้ไข            $model = new User ();            $id = $_POST ['User'] ['id'];            if (!empty($id))                $model = User::model()->findByPk($id);            // Save to Data base            $model->attributes = $_POST ['User'];            $model->user_note = $_POST['user_note'];            if ($model->save()) {                // Yii::app()->user->setFlash('register', 'บันทึกเรียบร้อย');                if ($savetype == 1)                    $this->redirect(array('User/UserForm'));                $msg_text = "<div class='facebox-save-success'>บันทึกข้อมูลเรียบร้อย</div>";                // ตรวจสอบ id ถ้ามีค่าเป็นการแก้ไข                // แต่ถ้าไม่มีค่าเป็นการเพิ่มใหม่                if (empty($id))                    $id = Yii::app()->db->getLastInsertID();            }        }        // ค้นหาและแสดงข้อมูลในฟอร์มเพื่อรอการแก้ไข        $model = new User ();        // echo 'id : ' . @$id;        if (!empty($id))            $model = User::model()->findByPk($id);        // Render Form        $this->render("/User/UserForm", array("model" => $model, "msg_text" => $msg_text));    }    public function actionLogout() {        unset(Yii::app()->session ["id"]);        unset(Yii::app()->session ["username"]);        $this->redirect(Yii::app()->homeUrl);    }    /**     * Performs the AJAX validation.     *      * @param     *       	 CModel the model to be validated     */    protected function performAjaxValidation($model) {        if (isset($_POST ['ajax']) && $_POST ['ajax'] === 'myform') {            echo CActiveForm::validate($model);            Yii::app()->end();        }    }    // ========= Business Section ==========    public function actionBusinessForm($id = NULL) {        Yii::app()->theme = "admin";        $user_id = Yii::app()->session ['id']; // User Id for business        $msg_text = "";        $OldFile = "";        // Create Folder by User ID not Business id        $folder = 'upload/business/' . $user_id . '/';        if (!file_exists($folder)) {            mkdir($folder);            chmod($folder, 0777);        }        if (!empty($_POST ["Business"])) {            $savetype = $_POST ['savetype']; // check return when saved            // ใช้ในกรณีแก้ไข            $model = new Business ();            $id = $_POST ['Business'] ['id'];            if (!empty($id)) {                $model = Business::model()->findByPk($id);                $OldFile = $model->banner;            }            $model->attributes = $_POST ['Business'];            // Check Old File            $file = CUploadedFile::getInstance($model, 'banner');            if ((is_object($file) && get_class($file) === 'CUploadedFile'))                $model->banner = $file;            else                $model->banner = $OldFile;            if ($model->save()) {                if ((is_object($file) && get_class($file) === 'CUploadedFile')) {                    // print_r("<br>in save file");                    $file->saveAs($folder . $file->getName());                    // resize image                    $fname = $folder . $file->getName();                    $image = Yii::app()->image->load($fname);                    $image->resize(80, 50);                    $image->save();                    // ลบ ภาพ เดิมออก                    if (empty($OldFile)) {                        $old_file = $folder . $OldFile;                        if (file_exists($old_file))                            unlink($old_file);                    }                }                if ($savetype == 1)                    $this->redirect(array('User/BusinessForm'));                $msg_text = "<div class = 'facebox-save-success'>บันทึกข้อมูลเรียบร้อย</div>";                // ตรวจสอบ id ถ้ามีค่าเป็นการแก้ไข แต่ถ้าไม่มีค่าเป็นการเพิ่ม                if (empty($id))                    $id = Yii::app()->db->getLastInsertID();            } // model Save        } // ถ้ามีการ submit        // ค้น user มีธุรกิจหรือยัง        $criteria = new CDbCriteria ();        $criteria->condition = "user_id = $user_id";        $model = Business::model()->find($criteria);        if (!empty($model)) {            // ถึงธุรกิจขึ้นมากแก้ไข            $id = $model->id;            $model = Business::model()->findByPk($id);        } else {            // เพิ่มธุรกิจใหม่            $model = new Business ();        }        // Render Form        $this->render("/User/BusinessForm", array("model" => $model, "msg_text" => $msg_text));    }}?>